<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tenant Electricity Report</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <h1>Tenant Electricity Report</h1>
      <p class="subtitle">Upload your transactions CSV or pick an existing one to generate a styled PDF.</p>
      <div class="actions actions-expanded">
        <a class="btn btn-expanded" href="{{ url_for('record') }}">Record</a>
        <a class="btn btn-expanded" href="{{ url_for('browse') }}">Browse</a>
        <a class="btn btn-expanded" href="{{ url_for('sync') }}">Sync</a>
        <a class="btn btn-expanded" href="{{ url_for('config_page') }}">Settings</a>
      </div>
    </header>

    {% if status_data %}
    <div class="ticker ticker-large ticker-expandable" id="statusTicker">
      <div class="ticker-row ticker-main" onclick="toggleStatusDetails()">
        <span class="pill">CSV: {{ current_csv }}</span>
        <span class="pill pill-ground">Ground: {{ status_data.balances['Ground Floor'] }}</span>
        <span class="pill pill-first">First: {{ status_data.balances['First Floor'] }}</span>
        <span class="pill pill-second">Second: {{ status_data.balances['Second Floor'] }}</span>
        <span class="pill pill-recharge">Last Recharge: {{ status_data.last_recharge_amount }} by {{ status_data.last_recharge_tenant }}</span>
        {% if next_recharge %}
          <span class="pill pill-warning">Next recharge suggested: {{ next_recharge }}</span>
        {% endif %}
        <span class="pill pill-expand" id="expandIndicator">▼ Details</span>
      </div>
      
      <div class="ticker-details" id="statusDetails" style="display: none;">
        <div class="details-section">
          <h4>Last Readings</h4>
          <div class="details-grid">
            {% for tenant, reading in status_data.last_readings.items() %}
              <div class="detail-item">
                <span class="detail-label">{{ tenant }}:</span>
                <span class="detail-value">{{ reading }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        
        <div class="details-section">
          <h4>Current Balances</h4>
          <div class="details-grid">
            {% for tenant, balance in status_data.balances.items() %}
              <div class="detail-item">
                <span class="detail-label">{{ tenant }}:</span>
                <span class="detail-value">{{ balance }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        
        <div class="details-section">
          <h4>Recharge Information</h4>
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">Last Amount:</span>
              <span class="detail-value">{{ status_data.last_recharge_amount }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Last Tenant:</span>
              <span class="detail-value">{{ status_data.last_recharge_tenant }}</span>
            </div>
            {% if next_recharge %}
            <div class="detail-item">
              <span class="detail-label">Next Suggested:</span>
              <span class="detail-value detail-warning">{{ next_recharge }}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="toast">
          {% for message in messages %}
            <div class="toast-item neutral">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if csv_error %}
    <div class="card error-card">
      <div class="card-header centered">
        <h3>Configuration Error</h3>
        <p class="card-subtitle error-text">CSV file configuration issue detected</p>
      </div>
      <div class="error-message">
        <p>{{ csv_error }}</p>
        <p>Please go to <a href="{{ url_for('config_page') }}" class="error-link">Settings</a> to configure a valid CSV file.</p>
      </div>
    </div>
    {% else %}
    <form class="card" method="POST" enctype="multipart/form-data">
      <div class="card-header centered">
        <h3>Generate Report</h3>
        <p class="card-subtitle">Create a styled PDF report from your transaction data</p>
      </div>
      
      <div class="field">
        <label for="cutoff_date">Cutoff Date (optional)</label>
        <input id="cutoff_date" name="cutoff_date" type="date" placeholder="YYYY-MM-DD">
        <small>Filter records after this date</small>
      </div>

      <button class="btn primary" type="submit">Generate PDF</button>
    </form>
    {% endif %}

    {% if metrics %}
    <div class="card" style="margin-top:12px;">
      <div class="card-header centered">
        <h3>Usage Metrics</h3>
        <p class="card-subtitle">Overview of electricity consumption and costs</p>
      </div>
      <div class="metrics-grid">
        <div class="metric"><div class="metric-label">Total Usage</div><div class="metric-value">{{ '%.2f'|format(metrics.total_usage) }} units</div></div>
        <div class="metric"><div class="metric-label">Readings</div><div class="metric-value">{{ metrics.count_readings }}</div></div>
        <div class="metric"><div class="metric-label">Recharges</div><div class="metric-value">{{ metrics.count_recharges }}</div></div>
        <div class="metric"><div class="metric-label">Recharge Total</div><div class="metric-value">Rs.{{ '%.2f'|format(metrics.recharges_total) }}</div></div>
      </div>
      
      <div class="metrics-toggles">
        <label class="switch">
          <input type="checkbox" id="viewToggle">
          <span>Show tenant-wise</span>
        </label>
        <label class="switch">
          <input type="checkbox" id="costToggle" checked>
          <span>Show cost estimates</span>
        </label>
      </div>
      
      <div id="estimates" style="margin-top:12px;">
        <h4 style="margin:0 0 8px;">Monthly Estimates (based on last 3 months)</h4>
        <div class="estimates-grid">
          <div class="estimate">
            <div class="estimate-label">Ground Floor</div>
            <div class="estimate-units">{{ '%.1f'|format((metrics.monthly_avg_per_tenant.get('Ground Floor', 0) / metrics.per_unit_cost) if metrics.per_unit_cost > 0 else 0) }} units/month</div>
            <div class="estimate-cost">~Rs.{{ '%.0f'|format(metrics.monthly_avg_per_tenant.get('Ground Floor', 0)) }}/month</div>
          </div>
          <div class="estimate">
            <div class="estimate-label">First Floor</div>
            <div class="estimate-units">{{ '%.1f'|format((metrics.monthly_avg_per_tenant.get('First Floor', 0) / metrics.per_unit_cost) if metrics.per_unit_cost > 0 else 0) }} units/month</div>
            <div class="estimate-cost">~Rs.{{ '%.0f'|format(metrics.monthly_avg_per_tenant.get('First Floor', 0)) }}/month</div>
          </div>
          <div class="estimate">
            <div class="estimate-label">Second Floor</div>
            <div class="estimate-units">{{ '%.1f'|format((metrics.monthly_avg_per_tenant.get('Second Floor', 0) / metrics.per_unit_cost) if metrics.per_unit_cost > 0 else 0) }} units/month</div>
            <div class="estimate-cost">~Rs.{{ '%.0f'|format(metrics.monthly_avg_per_tenant.get('Second Floor', 0)) }}/month</div>
          </div>
          <div class="estimate">
            <div class="estimate-label">Total</div>
            <div class="estimate-units">{{ '%.1f'|format((metrics.monthly_avg_total / metrics.per_unit_cost) if metrics.per_unit_cost > 0 else 0) }} units/month</div>
            <div class="estimate-cost">~Rs.{{ '%.0f'|format(metrics.monthly_avg_total) }}/month</div>
          </div>
        </div>
        
        <div style="margin:16px 0 8px;">
          <p><strong>Per Unit Cost (last 3 months): Rs.{{ '%.2f'|format(metrics.per_unit_cost) }}</strong></p>
        </div>
      </div>
      
      <div id="monthlyChart" style="margin-top:12px;">
        <canvas id="chartMonthlyTotal" height="120"></canvas>
        <canvas id="chartMonthlyTenants" height="140" style="display:none;"></canvas>
      </div>
      
    </div>
    {% endif %}

    <footer>
      <p>Powered by ReportLab & Flask</p>
    </footer>
    </div>
 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Theme management - apply saved theme
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || 'dark';
    
    // Apply saved theme
    if (savedTheme !== 'dark') {
      root.className = '';
      root.classList.add(savedTheme);
    }

    // Utility function to convert hex to rgba
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Status ticker toggle functionality
    function toggleStatusDetails() {
      const details = document.getElementById('statusDetails');
      const indicator = document.getElementById('expandIndicator');
      const ticker = document.getElementById('statusTicker');
      
      if (details.style.display === 'none') {
        details.style.display = 'block';
        indicator.textContent = '▲ Click to collapse';
        ticker.classList.add('expanded');
      } else {
        details.style.display = 'none';
        indicator.textContent = '▼ Click for details';
        ticker.classList.remove('expanded');
      }
    }

    // Charts
    {% if metrics %}
    const monthlyLabels = {{ metrics.monthly_total.keys()|list|tojson }};
    const monthlyData = {{ metrics.monthly_total.values()|list|tojson }};
    const ground = monthlyLabels.map(l => ({{ metrics.monthly_usage|tojson }}[l] || {})['Ground Floor'] || 0);
    const first = monthlyLabels.map(l => ({{ metrics.monthly_usage|tojson }}[l] || {})['First Floor'] || 0);
    const second = monthlyLabels.map(l => ({{ metrics.monthly_usage|tojson }}[l] || {})['Second Floor'] || 0);
    
    let chartMonthlyTotal, chartMonthlyTenants;
    
    function createMonthlyTotal() {
      const ctx = document.getElementById('chartMonthlyTotal');
      if (ctx && !chartMonthlyTotal) {
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        const primaryRgba = primaryColor.startsWith('#') ?
          hexToRgba(primaryColor, 0.25) :
          primaryColor.replace('rgb(', 'rgba(').replace(')', ', 0.25)');
        
        chartMonthlyTotal = new Chart(ctx, {
          type: 'line',
          data: {
            labels: monthlyLabels,
            datasets: [{
              label: 'Monthly Total Usage (units)',
              data: monthlyData,
              borderColor: primaryColor,
              backgroundColor: primaryRgba,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            plugins: { legend: { labels: { color: getComputedStyle(document.body).color } } },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).color } },
              y: { ticks: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      }
    }
    
    function createMonthlyTenants() {
      const ctx = document.getElementById('chartMonthlyTenants');
      if (ctx && !chartMonthlyTenants) {
        const primaryColorTenant = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        const tenantColors = [
          primaryColorTenant.startsWith('#') ? hexToRgba(primaryColorTenant, 0.8) : primaryColorTenant.replace('rgb(', 'rgba(').replace(')', ', 0.8)'),
          primaryColorTenant.startsWith('#') ? hexToRgba(primaryColorTenant, 0.6) : primaryColorTenant.replace('rgb(', 'rgba(').replace(')', ', 0.6)'),
          primaryColorTenant.startsWith('#') ? hexToRgba(primaryColorTenant, 0.4) : primaryColorTenant.replace('rgb(', 'rgba(').replace(')', ', 0.4)')
        ];
        
        chartMonthlyTenants = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: monthlyLabels,
            datasets: [
              { label: 'Ground (units)', data: ground, backgroundColor: tenantColors[0] },
              { label: 'First (units)', data: first, backgroundColor: tenantColors[1] },
              { label: 'Second (units)', data: second, backgroundColor: tenantColors[2] },
            ]
          },
          options: {
            plugins: { legend: { labels: { color: getComputedStyle(document.body).color } } },
            scales: {
              x: { stacked: true, ticks: { color: getComputedStyle(document.body).color } },
              y: { stacked: true, ticks: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      }
    }
    
    // Initialize charts
    createMonthlyTotal();
    createMonthlyTenants();
    
    // Toggle handlers
    const viewToggle = document.getElementById('viewToggle');
    const costToggle = document.getElementById('costToggle');
    const estimates = document.getElementById('estimates');
    
    if (viewToggle) {
      viewToggle.addEventListener('change', () => {
        const showTenants = viewToggle.checked;
        const monthlyTotal = document.getElementById('chartMonthlyTotal');
        const monthlyTenants = document.getElementById('chartMonthlyTenants');
        
        if (showTenants) {
          monthlyTotal.style.display = 'none';
          monthlyTenants.style.display = 'block';
        } else {
          monthlyTotal.style.display = 'block';
          monthlyTenants.style.display = 'none';
        }
      });
      
      // Initialize display based on checkbox state
      const showTenants = viewToggle.checked;
      const monthlyTotal = document.getElementById('chartMonthlyTotal');
      const monthlyTenants = document.getElementById('chartMonthlyTenants');
      
      if (showTenants) {
        monthlyTotal.style.display = 'none';
        monthlyTenants.style.display = 'block';
      } else {
        monthlyTotal.style.display = 'block';
        monthlyTenants.style.display = 'none';
      }
    }
    
    if (costToggle) {
      costToggle.addEventListener('change', () => {
        estimates.style.display = costToggle.checked ? 'block' : 'none';
      });
      // Initialize display based on checkbox state
      estimates.style.display = costToggle.checked ? 'block' : 'none';
    }
    {% endif %}
  </script>
</body>
</html> 
</html> 