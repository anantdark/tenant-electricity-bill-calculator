<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Configuration</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <h1>Configuration</h1>
      <p class="subtitle">Manage repository PAT token and default CSV preferences.</p>
      <div class="actions">
        <a class="btn" href="{{ url_for('index') }}">Home</a>
        <a class="btn" href="{{ url_for('sync') }}">Sync</a>
      </div>
    </header>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="toast">
          {% for message in messages %}
            <div class="toast-item neutral">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form class="card" method="POST" enctype="multipart/form-data">
      <div class="card-header centered">
        <h3>Application Settings</h3>
        <p class="card-subtitle">Configure GitHub integration and default CSV preferences</p>
      </div>
      
      <div class="field">
        <label for="git_pat">GitHub Personal Access Token (for HTTPS remotes)</label>
        <input id="git_pat" name="git_pat" type="password" class="input-rounded" placeholder="Enter PAT (not committed; stored locally)">
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="csv_path">Default CSV</label>
          <select id="csv_path" name="csv_path">
            <option value="">Keep current ({{ current_csv }})</option>
            {% for c in csvs %}
              <option value="{{ c.path }}">{{ c.label }}</option>
            {% endfor %}
            <option value="__upload__">üìÅ Upload new CSV file...</option>
          </select>
          <!-- Hidden file input for uploading -->
          <input id="csv_upload_hidden" type="file" accept=".csv" style="display: none;">
          <div id="upload_status" style="display: none; margin-top: 10px;">
            <small id="upload_message">Uploading...</small>
          </div>
        </div>
        <div class="field">
          <label>Application Mode</label>
          <label class="switch">
            <input type="checkbox" id="localToggle" {% if localmode %}checked{% endif %}>
            <span>Local Mode</span>
          </label>
          <small>Disables Git operations for local-only usage</small>
        </div>
      </div>

      <div class="field">
        <label for="themeSelect">Theme Preference</label>
        <select id="themeSelect" name="theme" class="input-rounded">
          <optgroup label="Dark Themes">
            <option value="dark">Default Dark</option>
            <option value="catppuccin-mocha">Catppuccin Mocha</option>
            <option value="catppuccin-macchiato">Catppuccin Macchiato</option>
            <option value="catppuccin-frappe">Catppuccin Frappe</option>
          </optgroup>
          <optgroup label="Light Themes">
            <option value="light">Default Light</option>
            <option value="catppuccin-latte">Catppuccin Latte</option>
            <option value="light-blue">Light Blue</option>
            <option value="light-green">Light Green</option>
            <option value="light-purple">Light Purple</option>
          </optgroup>
        </select>
        <small>Choose your preferred theme and color palette</small>
      </div>

      <button class="btn primary" type="submit">Save Configuration</button>
    </form>
  </div>
  
  <script>
    // Theme selection functionality
    const themeSelect = document.getElementById('themeSelect');
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || 'dark';
    
    // Apply saved theme
    if (savedTheme !== 'dark') {
      root.className = '';
      root.classList.add(savedTheme);
    }
    
    if (themeSelect) {
      // Set the selected theme in the dropdown
      themeSelect.value = savedTheme;
      
      themeSelect.addEventListener('change', () => {
        const selectedTheme = themeSelect.value;
        
        // Remove all theme classes
        root.className = '';
        
        // Apply new theme (except for default dark)
        if (selectedTheme !== 'dark') {
          root.classList.add(selectedTheme);
        }
        
        // Save theme preference
        localStorage.setItem('theme', selectedTheme);
      });
    }
    
    // Local mode toggle functionality
    const localToggle = document.getElementById('localToggle');
    if (localToggle){
      localToggle.addEventListener('change', async () => {
        await fetch("{{ url_for('toggle_localmode') }}", {method:'POST'});
        location.reload();
      });
    }
    
    // CSV upload functionality - direct file picker
    const csvSelect = document.getElementById('csv_path');
    const hiddenFileInput = document.getElementById('csv_upload_hidden');
    const uploadStatus = document.getElementById('upload_status');
    const uploadMessage = document.getElementById('upload_message');
    
    if (csvSelect && hiddenFileInput) {
      csvSelect.addEventListener('change', () => {
        if (csvSelect.value === '__upload__') {
          // Trigger file picker immediately
          hiddenFileInput.click();
        }
      });
      
      hiddenFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) {
          // User cancelled file selection, reset dropdown
          csvSelect.value = '';
          return;
        }
        
        // Show upload status
        uploadStatus.style.display = 'block';
        uploadMessage.textContent = 'Uploading...';
        
        // Create FormData and upload file
        const formData = new FormData();
        formData.append('csv_file', file);
        
        try {
          const response = await fetch("{{ url_for('upload_csv') }}", {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            uploadMessage.textContent = result.message;
            
            // Refresh the page to update dropdown and current CSV
            setTimeout(() => {
              location.reload();
            }, 1000);
          } else {
            uploadMessage.textContent = result.message;
            uploadStatus.style.display = 'none';
            csvSelect.value = ''; // Reset dropdown
          }
        } catch (error) {
          uploadMessage.textContent = 'Upload failed: ' + error.message;
          uploadStatus.style.display = 'none';
          csvSelect.value = ''; // Reset dropdown
        }
        
        // Clear the file input for next use
        hiddenFileInput.value = '';
      });
    }
  </script>
</body>
</html>